# Stage 1: ncurses
# Build and install as cmlfs

# Ensure gawk exist on the host
mkdir build
pushd build
    CC=clang CXX=clang++ LD=ld.lld \
    AR=llvm-ar AS=llvm-as NM=llvm-nm \
    READELF=llvm-readelf RANLIB=llvm-ranlib STRIP=llvm-strip \
    OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump \
    ../configure AWK=gawk
    make -C include -j`nproc --all`
    make -C progs tic -j`nproc --all`
popd

# Build
CC=clang CXX=clang++ LD=ld.lld \
AR=llvm-ar AS=llvm-as NM=llvm-nm \
READELF=llvm-readelf RANLIB=llvm-ranlib STRIP=llvm-strip \
OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump \
./configure \
    --prefix=/llvmtools \
    --host=x86_64-pc-linux-musl \
    --build=x86_64-pc-linux-musl \
    --with-shared \
    --without-normal \
    --with-cxx-shared \
    --without-debug \
    --without-ada \
    --disable-stripping \
    AWK=gawk

# Install to llvmtools
make -j`nproc --all` && make TIC_PATH=$(pwd)/build/progs/tic install

# Some packages may not configure with the curses library
# in llvmtools. Create a compatibility links:
ln -sv libncursesw.so /llvmtools/lib/libncurses.so
ln -sv libncurses.so /llvmtools/lib/libtinfo.so
ln -sv libncurses.so /llvmtools/lib/libtinfow.so

sed -e 's/^#if.*XOPEN.*$/#if 1/' \
    -i /llvmtools/include/ncursesw/curses.h
mv /llvmtools/include/ncursesw/* /llvmtools/include/
rm -r /llvmtools/include/ncursesw